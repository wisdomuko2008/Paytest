<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flexi Tutors – Payment</title>

<script src="https://js.paystack.co/v2/inline.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background: #f4f6f4; }
  .main-wrapper { display: flex; flex-direction: column; align-items: center; width: 90%; max-width: 400px; }
  .container { background: #fff; padding: 30px; width: 100%; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); box-sizing: border-box; }
  h2 { color: #0b6623; margin-top: 0; }
  input { width: 100%; padding: 12px; margin: 15px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
  button { width: 100%; padding: 12px; background: #0b6623; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; }
  button:disabled { background: #ccc; cursor: not-allowed; }
  .pin-box { font-size: 28px; color: #0b6623; font-weight: bold; letter-spacing: 2px; background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0; border: 2px dashed #0b6623; }
  #qrcode { display: none; }
  .manual-link { color: #0b6623; text-decoration: underline; cursor: pointer; font-weight: bold; font-size: 14px; margin-top: 10px; display: inline-block; }
  .cbt-text-link { margin-top: 20px; color: #0b6623; text-decoration: none; font-weight: bold; font-size: 16px; }
</style>
</head>
<body>

<div id="qrcode"></div>

<div class="main-wrapper">
  <div class="container" id="content-area">
    <h2>CBT Access Payment</h2>
    <p>Pay <b>₦500</b> to get your Exam PIN</p>
    <input type="tel" id="whatsapp" placeholder="WhatsApp Number (080...)">
    <button id="payBtn" onclick="payWithPaystack()">Pay ₦500</button>
    <div id="status" style="margin-top:10px; font-size:12px; color:#666;"></div>
  </div>
  <a href="https://flexi-systems.github.io/FleximockCBT/" class="cbt-text-link">Go to CBT Test</a>
</div>

<script>
const LOGO_URL = "https://i.postimg.cc/WpFDwz38/1771700279759-2.jpg"; 
const SIGNATURE_URL = "https://i.postimg.cc/s2mWqLCR/Screenshot-20260221-200142-2.jpg"; 
const WEBSITE_URL = "https://flexi-systems.github.io/Flexi-Tutors/";

// Fixed Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCPumFid5YNTWug52q2VDtSDQTLU9REgss",
  authDomain: "flexi-tutors.firebaseapp.com",
  projectId: "flexi-tutors",
  storageBucket: "flexi-tutors.firebasestorage.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const toDataURL = url => fetch(url)
  .then(res => res.blob())
  .then(blob => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  }));

function payWithPaystack() {
  const whatsapp = document.getElementById("whatsapp").value.trim();
  if (whatsapp.length < 10) return alert("Enter valid number");

  const paystack = new PaystackPop();
  paystack.newTransaction({
    key: 'pk_test_9408761e58ce1fe7a3a57c0df2422d887c3d4b35',
    email: whatsapp + '@flexitutors.com',
    amount: 50000,
    currency: "NGN",
    onSuccess: (t) => {
       // Force UI update immediately so user sees success
       showSuccessScreen(whatsapp, t.reference);
    },
    onCancel: () => {
       document.getElementById("status").innerText = "Payment cancelled.";
    }
  });
}

async function showSuccessScreen(num, ref) {
  const pin = "FT-" + Math.random().toString(36).substring(2, 8).toUpperCase();
  const serialID = "FT-" + Date.now().toString().slice(-6);
  const dateStr = new Date().toLocaleString();

  // 1. Update the UI first
  document.getElementById("content-area").innerHTML = `
    <h2 style="color:green">Success!</h2>
    <div class="pin-box">${pin}</div>
    <p id="dl-status">Your receipt is downloading...</p>
    <span class="manual-link" onclick="generateReceipt('${num}', '${pin}', '${ref}', '${dateStr}', '${serialID}')">
      Click here to download receipt manually
    </span>
    <br><br>
    <button onclick="window.location.reload()" style="background:#555;">New Payment</button>
  `;

  // 2. Generate Receipt
  generateReceipt(num, pin, ref, dateStr, serialID);

  // 3. Save to Firebase in the background
  try {
    await db.collection("subscriptions").doc(num).set({
      whatsapp: num,
      pin: pin,
      reference: ref,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  } catch (e) {
    console.error("Firebase Save Error:", e);
  }
}

async function generateReceipt(phone, pin, ref, date, serialID) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  try {
    const [logoData, sigData] = await Promise.all([
      toDataURL(LOGO_URL),
      toDataURL(SIGNATURE_URL)
    ]);

    const qrcodeDiv = document.getElementById("qrcode");
    qrcodeDiv.innerHTML = "";
    new QRCode(qrcodeDiv, { text: WEBSITE_URL, width: 100, height: 100 });

    const waitQR = setInterval(() => {
      const canvas = qrcodeDiv.querySelector("canvas");
      if (!canvas) return;
      clearInterval(waitQR);
      const qrImage = canvas.toDataURL("image/png");

      doc.setFontSize(15);
      doc.setFont("helvetica","bold");
      doc.text("FLEXI TUTORS - CBT RECEIPT", 105, 20, { align:"center" });

      doc.setFontSize(9);
      doc.text("BILL RECEIPT - WEEKLY CBT MOCK TEST", 105, 27, { align:"center" });
      doc.line(20, 35, 190, 35);

      doc.setFontSize(9);
      doc.setFont("helvetica","normal");
      doc.text(`WHATSAPP: ${phone}`, 20, 44);
      doc.setFont("helvetica","bold");
      doc.text(`RECEIPT NO: ${ref.substring(0,8).toUpperCase()}`, 140, 44);
      doc.text(`EXAM PIN: ${pin}`, 140, 49);

      const qrX = 20, qrY = 58, qrSize = 22;
      doc.addImage(qrImage, 'PNG', qrX, qrY, qrSize, qrSize);
      doc.link(qrX, qrY, qrSize, qrSize, { url: WEBSITE_URL });

      doc.setTextColor(0,0,255);
      doc.setFontSize(9);
      doc.textWithLink("Click here to open CBT portal", qrX, qrY + qrSize + 8, { url: WEBSITE_URL });

      doc.setTextColor(0,0,0);
      doc.text(`RRR: ${ref}`, 120, 70);

      doc.autoTable({
        startY: 90,
        head: [['#','DESCRIPTION','AMOUNT (NGN)']],
        body: [['1','CBT EXAM PORTAL ACCESS','500.00'],['','TOTAL PAID','500.00']],
        headStyles: { fillColor: [11, 102, 35] }
      });

      const finalY = doc.lastAutoTable.finalY;
      doc.addImage(sigData, 'JPEG', 20, finalY + 10, 35, 12);
      doc.line(20, finalY + 24, 65, finalY + 24);
      doc.setFontSize(8);
      doc.text("OLUSOLA AINA", 20, finalY + 29);
      doc.text(`Payment Date: ${date}`, 20, finalY + 45);

      doc.save(`FlexiTutors_Receipt_${phone}.pdf`);
      if(document.getElementById("dl-status")) {
          document.getElementById("dl-status").innerText = "Receipt downloaded successfully.";
      }
    }, 200);
  } catch (err) {
    console.error("PDF generation failed:", err);
  }
}
</script>
</body>
</html>
