<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flexi Tutors – Payment</title>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background: #f4f6f4; }
  .main-wrapper { display: flex; flex-direction: column; align-items: center; width: 90%; max-width: 400px; }
  .container { background: #fff; padding: 30px; width: 100%; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); box-sizing: border-box; }
  h2 { color: #0b6623; margin-top: 0; }
  input { width: 100%; padding: 12px; margin: 15px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
  button { width: 100%; padding: 12px; background: #0b6623; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; }
  button:disabled { background: #ccc; cursor: not-allowed; }
  .status { margin-top: 15px; font-size: 14px; color: #666; }
  .cbt-text-link { margin-top: 20px; color: #0b6623; text-decoration: none; font-weight: bold; font-size: 16px; }
  .pin-box { font-size: 28px; color: #0b6623; font-weight: bold; letter-spacing: 2px; background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0; border: 2px dashed #0b6623; }
  #qrcode { display: none; }
</style>
</head>
<body>

<div id="qrcode"></div>

<div class="main-wrapper">
  <div class="container" id="content-area">
    <h2>CBT Access Payment</h2>
    <p>Pay <b>₦500</b> to get your Exam PIN</p>
    <input type="tel" id="whatsapp" placeholder="WhatsApp Number (080...)">
    <button id="payBtn" onclick="payWithPaystack()">Pay ₦500</button>
    <div class="status" id="status"></div>
  </div>
  <a href="https://flexi-systems.github.io/FleximockCBT/" class="cbt-text-link">Go to CBT Test</a>
</div>

<script>
  // --- ASSET CONFIGURATION ---
  const LOGO_URL = "https://your-logo-link.png"; 
  const SIGNATURE_URL = "https://your-signature-link.png"; 
  const WEBSITE_URL = "https://flexi-systems.github.io/Flexi-Tutors/";

  const firebaseConfig = {
    apiKey: "AIzaSyCPumFid5YNTWug52q2VDtSDQTLU9REgss",
    authDomain: "flexi-tutors.firebaseapp.com",
    projectId: "flexi-tutors",
    storageBucket: "flexi-tutors.firebasestorage.app",
    messagingSenderId: "320176672406",
    appId: "1:320176672406:web:90f19511241e51c6437cb7"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const SECRET_KEY = "FLEXI_CBT_SECURE_2026"; // Maintained secret key

  function payWithPaystack() {
    const whatsapp = document.getElementById("whatsapp").value.trim();
    const status = document.getElementById("status");
    const payBtn = document.getElementById("payBtn");

    if (whatsapp.length < 10) { alert("Invalid Number"); return; }
    payBtn.disabled = true;
    status.textContent = "Processing Payment...";

    const handler = PaystackPop.setup({
      key: 'pk_live_bb0c7b83bfdbd0c9990e2c7f7fd73a86d4821a00', 
      email: whatsapp + '@flexitutors.com',
      amount: 50000, 
      currency: "NGN",
      callback: function(response) {
        status.textContent = "Payment Verified! Generating Receipt...";
        saveUserToFirebase(whatsapp, response.reference);
      },
      onClose: function() {
        payBtn.disabled = false;
        status.textContent = "Cancelled.";
      }
    });
    handler.openIframe();
  }

  async function saveUserToFirebase(num, ref) {
    const pin = "FT-" + Math.random().toString(36).substring(2, 8).toUpperCase();
    const dateStr = new Date().toLocaleString();
    try {
      await db.collection("subscriptions").doc(num).set({
        whatsapp: num, pin: pin, paid: true, reference: ref,
        access_key: SECRET_KEY, createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById("content-area").innerHTML = `
        <h2 style="color:green">Success!</h2>
        <div class="pin-box">${pin}</div>
        <p>Your institutional receipt is downloading...</p>
        <button onclick="window.location.reload()" style="background:#555; margin-top:10px;">Make Another Payment</button>
      `;
      generateReceipt(num, pin, ref, dateStr);
    } catch (e) { console.error(e); }
  }

    // --- ASSET CONFIGURATION ---
  // Paste your direct image links here
  const LOGO_URL = "https://i.postimg.cc/WpFDwz38/1771700279759-2.jpg"; 
  const SIGNATURE_URL = "https://i.postimg.cc/s2mWqLCR/Screenshot-20260221-200142-2.jpg"; 
  const WEBSITE_URL = "https://flexi-systems.github.io/Flexi-Tutors/";

  function generateReceipt(phone, pin, ref, date) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // QR Code Generation
    const qrcodeDiv = document.getElementById("qrcode");
    qrcodeDiv.innerHTML = "";
    new QRCode(qrcodeDiv, { text: WEBSITE_URL, width: 100, height: 100 });

    // We use a small delay to ensure external images and QR are ready
    setTimeout(() => {
      try {
        const qrImage = qrcodeDiv.querySelector("canvas").toDataURL("image/png");
        
        // 1. Watermark (Center)
        doc.setGState(new doc.GState({ opacity: 0.08 }));
        // addImage(link, type, x, y, width, height)
        doc.addImage(LOGO_URL, 'PNG', 55, 80, 100, 100, undefined, 'FAST'); 
        doc.setGState(new doc.GState({ opacity: 1.0 }));

        // 2. Main Logo (Top Left)
        doc.addImage(LOGO_URL, 'PNG', 20, 12, 18, 18, undefined, 'FAST');

        // 3. Header Text
        doc.setFontSize(15);
        doc.setFont("helvetica", "bold");
        doc.text("FLEXI TUTORS - CBT PORTAL", 105, 20, { align: "center" });
        doc.setFontSize(9);
        doc.text("BILL RECEIPT - WEEKLY CBT MOCK TEST", 105, 27, { align: "center" });

        // 4. User Info Block
        doc.setDrawColor(200);
        doc.line(20, 35, 190, 35);
        doc.setFontSize(8.5);
        doc.setFont("helvetica", "normal");
        doc.text(`WHATSAPP: ${phone}`, 20, 44);
        doc.text(`SESSION: 2025/2026 SECOND TERM`, 20, 49);
        doc.setFont("helvetica", "bold");
        doc.text(`RECEIPT NO: ${ref.substring(0, 8).toUpperCase()}`, 140, 44);
        doc.text(`EXAM PIN: ${pin}`, 140, 49);

        // 5. QR Code & PAID Status
        doc.addImage(qrImage, 'PNG', 20, 58, 18, 18);
        doc.link(20, 58, 18, 18, { url: WEBSITE_URL }); // Makes QR clickable
        doc.setFontSize(10);
        doc.text(`RRR: ${ref}`, 120, 68);
        doc.setTextColor(11, 102, 35); // Flexi Green
        doc.text("PAID", 182, 68);

        // 6. Table
        doc.autoTable({
          startY: 82,
          head: [['#', 'FEES DESCRIPTION', 'AMOUNT (NGN)']],
          body: [
            ['1', 'CBT EXAM PORTAL ACCESS FEE', '500.00'],
            ['', 'TOTAL PAID', '500.00']
          ],
          theme: 'grid',
          headStyles: { fillColor: [255, 255, 255], textColor: [0, 0, 0], lineWidth: 0.1 },
          styles: { fontSize: 8.5, cellPadding: 3.5 },
          columnStyles: { 2: { halign: 'right', fontStyle: 'bold' } }
        });

        const finalY = doc.lastAutoTable.finalY;
        
        // 7. Signature Section
        // This pulls your signature link and places it above the line
        doc.addImage(SIGNATURE_URL, 'PNG', 20, finalY + 12, 35, 12, undefined, 'FAST');
        doc.setTextColor(0, 0, 0);
        doc.line(20, finalY + 26, 65, finalY + 26);
        doc.setFont("helvetica", "bold");
        doc.text("OLUSOLA AINA", 20, finalY + 31);
        doc.setFontSize(7);
        doc.text("CHIEF BURSAR - FLEXI TUTORS", 20, finalY + 35);

        // 8. Footer Info
        doc.setFontSize(7.5);
        doc.setTextColor(100);
        doc.text(`Payment Date: ${date}`, 20, finalY + 50);
        doc.text("This is a digitally generated receipt. No physical stamp required.", 20, finalY + 55);

        doc.save(`FlexiTutors_Receipt_${phone}.pdf`);
      } catch (err) {
        console.error("PDF Generation Error:", err);
        alert("Could not load images for the PDF. Please check your image links.");
      }
    }, 800); // Increased delay slightly for external links
  }
</script>
</body>
</html>
