<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flexi CBT ‚Äì Payment</title>

<!-- Paystack -->
<script src="https://js.paystack.co/v1/inline.js"></script>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyCPumFid5YNTWug52q2VDtSDQTLU9REgss",
  authDomain: "flexi-tutors.firebaseapp.com",
  projectId: "flexi-tutors",
  storageBucket: "flexi-tutors.firebasestorage.app",
  messagingSenderId: "320176672406",
  appId: "1:320176672406:web:90f19511241e51c6437cb7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== PAY FUNCTION =====
window.pay = function() {
  const whatsapp = document.getElementById("whatsapp").value.trim();
  const status = document.getElementById("status");

  if (!whatsapp) {
    status.textContent = "‚ùå Enter your WhatsApp number";
    return;
  }

  status.textContent = "Opening payment gateway...";

  const handler = PaystackPop.setup({
    key: "pk_live_bb0c7b83bfdbd0c9990e2c7f7fd73a86d4821a00", // üî¥ Replace with your live key
    email: whatsapp + "@flexicbt.com",
    amount: 500 * 100,
    currency: "NGN",
    callback: async function(response) {
      status.textContent = "‚úÖ Payment successful. Generating PIN...";

      try {
        const pin = "FT-" + Math.random().toString(36).substring(2, 8).toUpperCase();

        await setDoc(doc(db, "subscriptions", whatsapp), {
          whatsapp,
          pin,
          paid: true,
          used: false,
          reference: response.reference,
          createdAt: serverTimestamp()
        });

        status.innerHTML = `
          <strong>PAYMENT CONFIRMED ‚úÖ</strong><br><br>
          WhatsApp Number:<br>
          <b>${whatsapp}</b><br><br>
          CBT PIN:<br>
          <b style="font-size:22px">${pin}</b><br><br>
          You can now access the CBT exam.
        `;
      } catch(err) {
        console.error(err);
        status.textContent = "‚ùå Payment verified but failed to save PIN. Try again later.";
      }
    },
    onClose: function() {
      status.textContent = "‚ùå Payment cancelled";
    }
  });

  handler.openIframe();
};
</script>

<style>
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(120deg,#dff6dd,#f4f6f4);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
}
.container {
  background: #fff;
  padding: 35px 25px;
  width: 100%;
  max-width: 420px;
  border-radius: 15px;
  box-shadow: 0 10px 25px rgba(0,0,0,.2);
  text-align: center;
}
h2 {
  color: #0b6623;
  margin-bottom: 12px;
}
p {
  font-size: 16px;
  margin-bottom: 20px;
}
input {
  width: 100%;
  padding: 14px;
  margin: 10px 0;
  border-radius: 10px;
  border:1px solid #ccc;
  font-size:16px;
}
button {
  width: 100%;
  padding: 14px;
  background: #0b6623;
  color: #fff;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}
button:hover {
  background: #084d1a;
}
.status {
  margin-top: 20px;
  font-weight: bold;
  font-size: 16px;
}
</style>
</head>
<body>
<div class="container">
  <h2>CBT Access Payment</h2>
  <p>Pay <b>‚Ç¶500</b> to unlock the CBT exam</p>

  <input type="tel" id="whatsapp" placeholder="WhatsApp Number e.g. 0803xxxxxxx">

  <button onclick="pay()">Pay ‚Ç¶500</button>

  <div class="status" id="status"></div>
</div>
</body>
</html>
