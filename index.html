<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flexi Tutors – Payment</title>

<script src="https://js.paystack.co/v2/inline.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background: #f4f6f4; }
  .main-wrapper { display: flex; flex-direction: column; align-items: center; width: 90%; max-width: 400px; }
  .container { background: #fff; padding: 30px; width: 100%; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); box-sizing: border-box; }
  h2 { color: #0b6623; margin-top: 0; }
  input { width: 100%; padding: 12px; margin: 15px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
  button { width: 100%; padding: 12px; background: #0b6623; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; }
  button:disabled { background: #ccc; cursor: not-allowed; }
  .status { margin-top: 15px; font-size: 14px; color: #666; }
  .cbt-text-link { margin-top: 20px; color: #0b6623; text-decoration: none; font-weight: bold; font-size: 16px; }
  .pin-box { font-size: 28px; color: #0b6623; font-weight: bold; letter-spacing: 2px; background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0; border: 2px dashed #0b6623; }
  #qrcode { display: none; }
  .manual-dl { color: #0b6623; text-decoration: underline; cursor: pointer; font-weight: bold; font-size: 14px; }
</style>
</head>
<body>

<div id="qrcode"></div>

<div class="main-wrapper">
  <div class="container" id="content-area">
    <h2>CBT Access Payment</h2>
    <p>Pay <b>₦500</b> to get your Exam PIN</p>
    <input type="tel" id="whatsapp" placeholder="WhatsApp Number (080...)">
    <button id="payBtn" onclick="payWithPaystack()">Pay ₦500</button>
    <div class="status" id="status"></div>
  </div>
  <a href="https://flexi-systems.github.io/FleximockCBT/" class="cbt-text-link">Go to CBT Test</a>
</div>

<script>
  const LOGO_URL = "https://i.postimg.cc/WpFDwz38/1771700279759-2.jpg"; 
  const SIGNATURE_URL = "https://i.postimg.cc/s2mWqLCR/Screenshot-20260221-200142-2.jpg"; 
  const WEBSITE_URL = "https://flexi-systems.github.io/Flexi-Tutors/";

  const firebaseConfig = {
    apiKey: "AIzaSyCPumFid5YNTWug52q2VDtSDQTLU9REgss",
    authDomain: "flexi-tutors.firebaseapp.com",
    projectId: "flexi-tutors",
    storageBucket: "flexi-tutors.firebasestorage.app",
    messagingSenderId: "320176672406",
    appId: "1:320176672406:web:90f19511241e51c6437cb7"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const SECRET_KEY = "FLEXI_CBT_SECURE_2026";

  const toDataURL = url => fetch(url)
    .then(response => response.blob())
    .then(blob => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    }));

  function payWithPaystack() {
    const whatsapp = document.getElementById("whatsapp").value.trim();
    const status = document.getElementById("status");
    const payBtn = document.getElementById("payBtn");

    if (whatsapp.length < 10) { alert("Please enter a valid WhatsApp number"); return; }
    
    payBtn.disabled = true;
    status.textContent = "Loading payment window...";

    try {
      const paystack = new PaystackPop();
      paystack.newTransaction({
        key: 'pk_test_9408761e58ce1fe7a3a57c0df2422d887c3d4b35', 
        email: whatsapp + '@flexitutors.com',
        amount: 50000, 
        currency: "NGN",
        onSuccess: (transaction) => {
          status.textContent = "Payment successful! Generating PIN...";
          saveUserToFirebase(whatsapp, transaction.reference);
        },
        onCancel: () => {
          payBtn.disabled = false;
          status.textContent = "Payment was cancelled.";
        },
        onError: (error) => {
          payBtn.disabled = false;
          status.textContent = "Error: " + error.message;
        }
      });
    } catch (e) {
      payBtn.disabled = false;
      status.textContent = "Failed to load Paystack.";
      console.error(e);
    }
  }

  async function saveUserToFirebase(num, ref) {
    const pin = "FT-" + Math.random().toString(36).substring(2, 8).toUpperCase();
    const serialID = "FT-" + Date.now().toString().slice(-6) + "-" + Math.floor(Math.random() * 100);
    const dateStr = new Date().toLocaleString();
    
    try {
      await db.collection("subscriptions").doc(num).set({
        whatsapp: num, 
        pin: pin, 
        receiptSerial: serialID,
        paid: true, 
        reference: ref,
        access_key: SECRET_KEY, 
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Update UI with clickable text to trigger download
      document.getElementById("content-area").innerHTML = `
        <h2 style="color:green">Success!</h2>
        <div class="pin-box">${pin}</div>
        <p style="font-size:12px; color:#666;">Receipt ID: ${serialID}</p>
        <p>Your institutional receipt is downloading...</p>
        <p><span class="manual-dl" onclick="generateReceipt('${num}', '${pin}', '${ref}', '${dateStr}', '${serialID}')">Click here to download manually</span></p>
        <button onclick="window.location.reload()" style="background:#555; margin-top:20px;">New Payment</button>
      `;
      generateReceipt(num, pin, ref, dateStr, serialID);
    } catch (e) { 
        console.error(e);
    }
  }

  async function generateReceipt(phone, pin, ref, date, serialID) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    try {
      const [logoData, sigData] = await Promise.all([
        toDataURL(LOGO_URL),
        toDataURL(SIGNATURE_URL)
      ]);

      const qrcodeDiv = document.getElementById("qrcode");
      qrcodeDiv.innerHTML = "";
      new QRCode(qrcodeDiv, { text: WEBSITE_URL, width: 100, height: 100 });

      setTimeout(() => {
        const canvas = qrcodeDiv.querySelector("canvas");
        if(!canvas) return;
        const qrImage = canvas.toDataURL("image/png");
        
        // Watermark
        doc.setGState(new doc.GState({ opacity: 0.08 }));
        doc.addImage(logoData, 'JPEG', 55, 80, 100, 100); 
        doc.setGState(new doc.GState({ opacity: 1.0 }));

        // Serial ID
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(`SERIAL: ${serialID}`, 190, 10, { align: "right" });

        // Header
        doc.addImage(logoData, 'JPEG', 20, 12, 18, 18);
        doc.setTextColor(0);
        doc.setFontSize(15);
        doc.setFont("helvetica", "bold");
        doc.text("FLEXI TUTORS - CBT RECEIPT", 105, 20, { align: "center" });
        doc.setFontSize(9);
        doc.text("BILL RECEIPT - WEEKLY CBT MOCK TEST", 105, 27, { align: "center" });

        doc.setDrawColor(200);
        doc.line(20, 35, 190, 35);

        // Details
        doc.setFontSize(8.5);
        doc.setFont("helvetica", "normal");
        doc.text(`WHATSAPP: ${phone}`, 20, 44);
        doc.text(`SESSION: 2026/2027`, 20, 49);
        doc.setFont("helvetica", "bold");
        doc.text(`RECEIPT NO: ${ref.substring(0, 8).toUpperCase()}`, 140, 44);
        doc.text(`EXAM PIN: ${pin}`, 140, 49);

        // QR Section & Interactive Link
        const qrX = 20, qrY = 58, qrSize = 20;
        doc.addImage(qrImage, 'PNG', qrX, qrY, qrSize, qrSize);
        // This is the clickable layer on the QR code
        doc.link(qrX, qrY, qrSize, qrSize, { url: WEBSITE_URL });
        
        // Blue clickable text fallback
        doc.setFontSize(7);
        doc.setTextColor(0, 0, 255);
        doc.text("Click here to verify", qrX, qrY + qrSize + 4);
        doc.link(qrX, qrY + qrSize, 25, 5, { url: WEBSITE_URL });

        // Payment Info
        doc.setFontSize(10);
        doc.setTextColor(0,0,0);
        doc.text(`RRR: ${ref}`, 120, 68);
        doc.setTextColor(11, 102, 35);
        doc.text("PAID", 182, 68);

        doc.autoTable({
          startY: 88,
          head: [['#', 'FEES DESCRIPTION', 'AMOUNT (NGN)']],
          body: [['1', 'CBT EXAM PORTAL ACCESS FEE', '500.00'], ['', 'TOTAL PAID', '500.00']],
          theme: 'grid',
          headStyles: { fillColor: [255, 255, 255], textColor: [0, 0, 0], lineWidth: 0.1 },
          styles: { fontSize: 8.5, cellPadding: 3.5 },
          columnStyles: { 2: { halign: 'right', fontStyle: 'bold' } }
        });

        const finalY = doc.lastAutoTable.finalY;
        
        doc.addImage(sigData, 'JPEG', 20, finalY + 12, 35, 12);
        doc.setTextColor(0,0,0);
        doc.line(20, finalY + 26, 65, finalY + 26);
        doc.setFont("helvetica", "bold");
        doc.text("OLUSOLA AINA", 20, finalY + 31);
        doc.setFontSize(7);
        doc.text("CHIEF BURSAR - FLEXI TUTORS", 20, finalY + 35);

        doc.setFontSize(7.5);
        doc.setTextColor(100);
        doc.text(`Payment Date: ${date}`, 20, finalY + 50);
        doc.text("This is a digitally generated receipt. No physical stamp required.", 20, finalY + 55);

        const pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();
        doc.setFontSize(8);
        doc.setFont("helvetica", "italic");
        doc.setTextColor(150);
        doc.text("Powered by FLEXI SYSTEMS", 105, pageHeight - 10, { align: "center" });

        doc.save(`FlexiTutors_Receipt_${phone}.pdf`);
      }, 800);
    } catch (err) {
      console.error("PDF generation failed:", err);
    }
  }
</script>
</body>
  </html>
  
